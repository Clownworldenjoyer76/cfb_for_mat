<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Win Probability CSV Generator</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    textarea { width: 100%; height: 260px; }
    button { margin-top: 10px; padding: 8px 14px; }
    table { border-collapse: collapse; margin-top: 20px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #f4f4f4; }
    .error { color: red; font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>

<h2>Win Probability CSV Generator</h2>

<label>Paste raw probability data:</label>
<textarea id="input"></textarea>

<br/>
<button onclick="generatePreview()">Generate CSV Preview</button>

<div id="error" class="error"></div>
<div id="preview"></div>

<hr/>

<label>GitHub Token (repo-scoped, contents:write):</label>
<input type="password" id="token" style="width:100%;" />

<br/>
<button onclick="commitCSV()">Commit CSV to GitHub</button>

<script>
let parsedRows = [];

function generatePreview() {
  document.getElementById("error").innerText = "";
  parsedRows = [];

  let lines = document.getElementById("input").value
    .split("\n")
    .map(l => l.trim())
    .filter(Boolean);

  try {
    while (true) {
      const game = extractOneGame(lines);
      if (!game) break;

      const { date, time, teamA, teamB, pA, pB } = game;

      parsedRows.push([date, time, teamA, teamB, pA]);
      parsedRows.push([date, time, teamB, teamA, pB]);
    }

    if (parsedRows.length === 0) {
      throw new Error("No complete games found in input.");
    }

    renderPreview();
  } catch (e) {
    showError(e.message);
  }
}

function extractOneGame(lines) {
  const dateIdx = lines.findIndex(isDate);
  const timeIdx = lines.findIndex(isTime);
  const teamIdxs = lines
    .map((l, i) => l.match(/\(.+\)/) ? i : -1)
    .filter(i => i !== -1);

  const percentIdxs = lines
    .map((l, i) => l.match(/\d+(\.\d+)?%/) ? i : -1)
    .filter(i => i !== -1);

  if (dateIdx === -1 || timeIdx === -1 || teamIdxs.length < 2 || percentIdxs.length < 2) {
    return null;
  }

  const teamA = stripRecord(lines[teamIdxs[0]]);
  const teamB = stripRecord(lines[teamIdxs[1]]);

  const pA = percentToDecimal(lines[percentIdxs[0]]);
  const pB = percentToDecimal(lines[percentIdxs[1]]);

  const date = toISODate(lines[dateIdx]);
  const time = to24Hour(lines[timeIdx]);

  const used = [dateIdx, timeIdx, teamIdxs[0], teamIdxs[1], percentIdxs[0], percentIdxs[1]]
    .sort((a, b) => b - a);

  used.forEach(i => lines.splice(i, 1));

  return { date, time, teamA, teamB, pA, pB };
}

function isDate(l) {
  return /^\d{2}\/\d{2}\/\d{4}$/.test(l);
}

function isTime(l) {
  return /^\d{1,2}:\d{2}\s?(AM|PM)$/.test(l);
}

function stripRecord(team) {
  return team.replace(/\s*\([^)]*\)/g, "").trim();
}

function percentToDecimal(p) {
  return (parseFloat(p.replace("%", "")) / 100).toFixed(4);
}

function toISODate(d) {
  const [m, day, y] = d.split("/");
  return `${y}-${m.padStart(2,"0")}-${day.padStart(2,"0")}`;
}

function to24Hour(t) {
  let [time, meridian] = t.split(" ");
  let [h, m] = time.split(":").map(Number);
  if (meridian === "PM" && h !== 12) h += 12;
  if (meridian === "AM" && h === 12) h = 0;
  return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
}

function renderPreview() {
  let html = "<table><tr><th>date</th><th>time</th><th>team</th><th>opponent</th><th>win_probability</th></tr>";
  parsedRows.forEach(r => {
    html += `<tr><td>${r.join("</td><td>")}</td></tr>`;
  });
  html += "</table>";
  document.getElementById("preview").innerHTML = html;
}

function showError(msg) {
  document.getElementById("error").innerText = msg;
}

async function commitCSV() {
  if (parsedRows.length === 0) {
    showError("No parsed data to commit.");
    return;
  }

  const token = document.getElementById("token").value;
  if (!token) {
    showError("GitHub token required.");
    return;
  }

  const now = new Date();
  const ts =
    now.getUTCFullYear().toString() +
    String(now.getUTCMonth() + 1).padStart(2,"0") +
    String(now.getUTCDate()).padStart(2,"0") + "_" +
    String(now.getUTCHours()).padStart(2,"0") +
    String(now.getUTCMinutes()).padStart(2,"0") +
    String(now.getUTCSeconds()).padStart(2,"0");

  const path = `docs/win/win_probability_${ts}.csv`;

  let csv = "date,time,team,opponent,win_probability\n";
  parsedRows.forEach(r => csv += r.join(",") + "\n");

  const res = await fetch(
    `https://api.github.com/repos/clownworldenjoyer76/cfb_for_mat/contents/${path}`,
    {
      method: "PUT",
      headers: {
        "Authorization": `token ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: `Add win_probability snapshot ${ts}`,
        content: btoa(csv)
      })
    }
  );

  if (!res.ok) showError("GitHub commit failed.");
  else alert("CSV committed successfully.");
}
</script>

</body>
</html>
